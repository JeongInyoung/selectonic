/*! Selectonic - v0.2.2 - 2013-12-27
* https://github.com/anovi/selectonic
* Copyright (c) 2013 Alexey Novichkov; Licensed MIT */
!function(a,b,c){"use strict";function d(b,c){this._name=e,this.el=b,this.$el=a(b),this.ui={},this._selected=0,this._changedItems=[],this._prevItemsState=[],this._isEnable=!0,this._keyModes={},this.options={};var d=a.extend({},j,c||{});this._setOptions(d),this._init()}var e="selectonic",f=b.document,g={DOWN:40,UP:38,SHIFT:16,END:35,HOME:36,PAGE_DOWN:34,PAGE_UP:33,A:65},h=["create","before","focusLost","select","unselect","unselectAll","stop","destroy"],i=["filter","mouseMode","event","listClass","focusClass","selectedClass","disabledClass","handle"],j={filter:"> *",multi:!0,mouseMode:"select",event:"mousedown",focusBlur:!1,selectionBlur:!1,handle:null,textSelection:!1,keyboard:!1,autoScroll:!0,loop:!1,preventInputs:!0,listClass:"j-selectable",focusClass:"j-focused",selectedClass:"j-selected",disabledClass:"j-disabled",create:null,before:null,focusLost:null,select:null,unselect:null,unselectAll:null,stop:null,destroy:null};d.getDataObject=function(b){return a(b).data("plugin_"+e)},d.prototype._init=function(){this.$el.addClass(this.options.listClass),this._onHandler(),this.$el.data("plugin_"+e,this),this._callEvent("create")},d.prototype._setOptions=function(){var b,c,d,e={},f=this;if(2===arguments.length)e[arguments[0]]=arguments[1];else{if(!a.isPlainObject(e))throw new Error("Option should be a pair arguments of name and value or should be a hash of pairs.");e=arguments[0]}a.each(i,function(c,d){if(b=e[d],b&&(b=a.trim(String(b)),f.options.parentSelector&&("listClass"===d||"focusClass"===d||"selectedClass"===d||"disabledClass"===d)))throw new Error("Sorry, it's not allowed to dynamically change classnames!")}),a.each(h,function(c,f){if(b=e[f],void 0!==b&&(d=a.isFunction(b),!d&&null!==b))throw new Error('Option "'+f+'" should be a function or "null"!')}),c=a.extend({},this.options,e),c.parentSelector="."+c.listClass+" "+c.filter,void 0!==e.autoScroll&&this._setScrolledElem(e.autoScroll),this.options=c},d.prototype._destroy=function(){this._callEvent("destroy"),this._offHandler(),this.ui.focus&&(a(this.ui.focus).removeClass(this.options.focusClass),delete this.ui.focus),this._selected>0&&this.getSelected().removeClass(this.options.selectedClass),this.$el.removeClass(this.options.disabledClass),this.$el.removeClass(this.options.listClass),this._scrolledElem&&delete this._scrolledElem},d.prototype._setScrolledElem=function(b){var c;if(null===b||!1===b)return delete this._scrolledElem,void 0;if("string"==typeof b){if(c=a(b),!(c.length>0))throw new Error('There are no elements that matches to selector - "'+b+'"');return this._scrolledElem=c[0],void 0}this._scrolledElem=this.el},d.prototype._prevent=function(){this._isPrevented=!0},d.prototype._cancel=function(b){this._isCancellation=!0,a.each(a(this._changedItems),a.proxy(function(c,d){this._prevItemsState[c]?this._select(b,a(d),!0):this._unselect(b,a(d),!0)},this)),delete this._isCancellation,delete this._isPrevented},d.prototype._onHandler=function(){this._mouseEventHandler=a.proxy(function(a){return this._isEnable&&this._mouseHandler(a),a},this),this._keyEventHandler=a.proxy(function(a){return this.options.keyboard&&this._isEnable&&this._keyHandler(a),a},this),this._selectstartHandler=a.proxy(function(){return this.options.textSelection?void 0:!1},this),a(f).on("click."+this._name+" mousedown."+this._name,this._mouseEventHandler),a(f).on("keydown."+this._name+" keyup."+this._name,this._keyEventHandler),this.$el.on("selectstart."+this._name,this._selectstartHandler)},d.prototype._offHandler=function(){a(f).off("click."+this._name+" mousedown."+this._name,this._mouseEventHandler),a(f).off("keydown."+this._name+" keyup."+this._name,this._keyEventHandler),this.$el.off("selectstart."+this._name,this._selectstartHandler)},d.prototype._getTarget=function(b){for(var c,d,e=b.target,g=this.options.handle;null!==e&&e!==this.el;)c=a(e),c.context=f,c.is(this.options.parentSelector)&&(d=e),g&&c.is(g)&&(this.ui.handle=e),e=e.parentNode;return g&&e&&this.ui.handle?d:!g&&e?d:null},d.prototype._getSelected=function(b){var c,d,e;return b?(c=[],e=this.$el.children("."+this.options.selectedClass),a.each(e,function(b,d){c.push(a(d).attr("id")||null)}),d=c.length>0?c:null):d=this.$el.children("."+this.options.selectedClass),d},d.prototype._getItems=function(c,d,e){switch(d){case"next":case"prev":for(var g=e.jquery?e:a(e),h=a.fn[d];;){if(g=h.call(g),0===g.length)break;if(g.context=f,g.is(c.parentSelector))return g}return null;case"pageup":case"pagedown":for(var i,j,k=this._scrolledElem||this.el,l=k.clientHeight,m=a(b).outerHeight(),n=a(e),o=l>m,p=o?m:l,q=n.outerHeight(),r=q,s=q,t="pageup"===d?"prev":"next";;){if(i=this._getItems(c,t,n),!i&&n.is(e))break;if(!i)return n;if(j=i.outerHeight(),s+=j,s>p)return r+j>p?i:n;r=j,n=i}return null;case"first":return this.$el.find(c.filter).first();case"last":return this.$el.find(c.filter).last();default:return this.$el.find(c.filter)}},d.prototype._callEvent=function(a,b){var c,d=this.options[a];if(d){if("create"===a||"destroy"===a)return d.call(this.$el);c={},this.ui.target&&(c.target=this.ui.target),this.ui.items&&(c.items=this.ui.items),this._prevFocus&&(c.focus=this._prevFocus),d.call(this.$el,b||null,c)}},d.prototype._controller=function(a){return this._callEvent("before",a),this._isPrevented?(this._cancel(a),this._stop(a),void 0):(this._prevFocus=this.ui.focus?this.ui.focus:null,this._isWasSelected=this._selected>0,this.ui.target&&this._isTargetWasSelected===c&&(this._isTargetWasSelected=this._getIsSelected(this.ui.target)),this._isRangeSelect&&this._isTargetWasSelected&&this.ui.target===this.ui.focus||(this._isRangeSelect||this._isMultiSelect?this._isTargetWasSelected?this._unselect(a,this._items):this._select(a,this._items):this.ui.target?(this._selected&&(1===this._selected&&this._getIsSelected(this.ui.focus)?this._unselect(a,this.ui.focus,this._isTargetWasSelected):this._unselectAll(a)),this._select(a,this._items,this._isTargetWasSelected)):(this.options.focusBlur&&this._blur(a),this._selected>0&&this.options.selectionBlur&&this._unselectAll(a))),this._setFocus(this.ui.target),this._stop(a),void 0)},d.prototype._forEachItem=function(b,c){var d=c>0,e=[],f=this;a(b).each(function(b,g){var h=f._getIsSelected(g),i=d?!h:h,j=g===f.ui.target&&f._isTargetWasSelected;(!j||d||f._isMultiSelect||f._isRangeSelect)&&(i&&(f._isCancellation||(e.push(g),f._prevItemsState.push(h)),f._selected+=c),a(g).toggleClass(f.options.selectedClass,d))}),this._isCancellation||(this.ui.items=a(e),this._changedItems=this._changedItems.concat(e))},d.prototype._select=function(a,b,c){this._forEachItem(b,1),c||this._callEvent("select",a),this._isPrevented&&!this._isCancellation&&this._cancel(a)},d.prototype._unselect=function(a,b,c){this._forEachItem(b,-1),c||this._callEvent("unselect",a),this._isPrevented&&!this._isCancellation&&this._cancel(a)},d.prototype._unselectAll=function(a){var b,c;this._selected&&0!==this._selected&&(c=this._getItems(this.options),b=this.ui.target&&this._isTargetWasSelected&&1===this._selected,this.ui.items=null,this._unselect(a,c,b))},d.prototype._multiSelect=function(){return this._isMultiSelect=!0,a(this.ui.target)},d.prototype._rangeSelect=function(){if(this._isRangeSelect=!0,this.ui.target===this.ui.focus)return a(this.ui.target);var b=this._getItems(this.options),c=b.index(this.ui.target),d=b.index(this.ui.focus),e=d>c?b.slice(c,d):b.slice(d,c);return e.push(d>c?b[d]:b[c]),e},d.prototype._getIsSelected=function(b){if(a(b).length<=1)return a(b).hasClass(this.options.selectedClass);var c=this.options;return a.map(a(b),function(b){return a(b).hasClass(c.selectedClass)})},d.prototype._blur=function(b,c){!c&&this.ui.focus&&this._callEvent("focusLost",b),this.ui.focus&&(a(this.ui.focus).removeClass(this.options.focusClass),delete this.ui.focus)},d.prototype._setFocus=function(b){return b?(this.ui.focus&&a(this.ui.focus).removeClass(this.options.focusClass),this.ui.focus=b,a(this.ui.focus).addClass(this.options.focusClass),this.ui.focus):void 0},d.prototype._stop=function(a){!this._selected&&this._isWasSelected&&this._callEvent("unselectAll",a),this.ui.items=this._changedItems,this._callEvent("stop",a),this._isPrevented&&this._cancel(a),this._changedItems=[],this._prevItemsState=[],delete this.ui.items,delete this.ui.target,delete this.ui.handle,delete this._items,delete this._isRangeSelect,delete this._isMultiSelect,delete this._isTargetWasSelected,delete this._isWasSelected},d.prototype._keyHandler=function(a){if(this.options.keyboard&&!(this.options.preventInputs&&"INPUT"===a.target.tagName||"TEXTAREA"===a.target.tagName)){var c,d,e,f=a.which;if("keyup"===a.type)return f===g.SHIFT&&(delete this._shiftModeAction,delete this._keyModes.shift),void 0;if(f===g.A&&(a.metaKey||a.ctrlKey)&&this.options.multi)a.preventDefault(),c=this._getItems(this.options),d=!0;else switch(f){case g.HOME:e="prev",c=this._getItems(this.options,"first");break;case g.END:e="next",c=this._getItems(this.options,"last");break;case g.DOWN:e="next",c=this._findNextSibling("next");break;case g.UP:e="prev",c=this._findNextSibling("prev")}return c&&c.length>0&&(a.preventDefault(),this.ui.target=c[0],this._items=c,this.ui.focus&&this.options.multi&&a.shiftKey&&!d&&(this._multiVariator(a,f,e,c),this._shiftModeAction||(this._shiftModeAction="select"),this._keyModes.shift||(this._keyModes.shift=f),f===g.END||f===g.HOME?this._items=this._rangeSelect():this._isMultiSelect=!0),this._controller(a),this.ui.focus&&(this._scrolledElem&&this._recalcBoxScroll(this._scrolledElem),this._recalcBoxScroll(b))),a}},d.prototype._multiVariator=function(a,b,c,d){var e=this._getIsSelected(this.ui.focus),f=this._getIsSelected(this.ui.target),g=this._getItems(this.options,c,d),h=this._getIsSelected(g);if(this._keyModes.shift&&this._keyModes.shift!==b&&(this._keyModes.shift=this._shiftModeAction=null),!(!e&&f&&this._selected>1))if(this._keyModes.shift&&"select"===this._shiftModeAction&&f){for(;this._getIsSelected(this._items)&&this._items.length>0;)this._items=this._getItems(this.options,c,this._items);this._items.length>0&&(this.ui.target=this._items)}else f&&e&&!h?(this._keyModes.shift=this._shiftModeAction=null,this._items=this.ui.focus):e&&f?(this._items=this.ui.focus,this._shiftModeAction||(this._shiftModeAction="unselect")):!e&&f?(this._items=this.ui.focus,this._isTargetWasSelected=!1):e||f||(this.ui.target=this._items=this.ui.focus)},d.prototype._findNextSibling=function(a){var b="next"===a||"pagedown"===a?"first":"last",c=this.ui.focus?this._getItems(this.options,a,this.ui.focus):this._getItems(this.options,b);return null!==c&&0!==c.length||!this.options.loop||(c=this._getItems(this.options,b)),c},d.prototype._recalcBoxScroll=function(c){var d=a(c),e=c===b,f=e?d.outerHeight():c.clientHeight,g=d.scrollTop(),h=e?0:d.offset().top,i=a(this.ui.focus),j=i.outerHeight(),k=e?i.offset().top:i.offset().top-h+g;g>k?d.scrollTop(k):k+j>g+f&&d.scrollTop(k+j-f)},d.prototype._mouseHandler=function(b){var c=this.options;if("hybrid"===c.event){if("click"===b.type&&!this._mouseDownMode)return;if(this.ui.target=this._getTarget(b),this.ui.target&&"mousedown"===b.type&&(this._isTargetWasSelected=this._getIsSelected(this.ui.target),this._isTargetWasSelected))return this._mouseDownMode=!0,void 0;this._mouseDownMode&&delete this._mouseDownMode}else{if(b.type!==c.event)return;this.ui.target=this._getTarget(b)}c.multi&&this.ui.target&&((b.shiftKey||b.shiftKey&&b.ctrlKey)&&this.ui.focus?this._items=this._rangeSelect():(b.ctrlKey||b.metaKey||"toggle"===c.mouseMode)&&(this._items=this._multiSelect())),this.ui.target&&!this._items&&(this._items=a(this.ui.target)),this._controller(b)},d._command=function(b){var c,f,g=d.getDataObject(this);if(null===g||void 0===g)throw new Error("Element "+this[0]+" has no plugin "+e);if(g[b]&&a.isFunction(g[b])&&(c=g[b]),c&&a.isFunction(c)&&"_"!==b.charAt(0))return c.apply(g,arguments);if(b&&b.addClass||b.nodeType)return g.select(a(b).filter(g.options.parentSelector));if(f=this.find(b).filter(g.options.parentSelector),f.jquery)return f.length>0?g.select(f):this;throw new Error('Plugin "'+e+'" has no method "'+b+'"')},d.prototype.isEnabled=function(){return this._isEnable},d.prototype.option=function(){var b=arguments[1],c=arguments.length;if(c>1&&b.charAt)return c>2?(this._setOptions(b,arguments[2]),this.$el):this.options[b];if(c>1&&a.isPlainObject(b))return this._setOptions(b),this.$el;if(1===c)return a.extend({},this.options);throw new Error('Format of "option" could be: "option" | "option", "name" | "option", "name", val | "option", {...}')},d.prototype.destroy=function(){this._destroy(),this.$el.removeData("plugin_"+e),this.$el=null},d.prototype.select=function(b){return this._items=b.addClass?b:a(b),this.ui.target=b[0]||b,this._controller(null),this.$el},d.prototype.blur=function(){return this.ui.target=null,this._controller(null),this.$el},d.prototype.getSelected=function(){return this._getSelected()},d.prototype.getSelectedId=function(){return this._getSelected(!0)},d.prototype.getFocused=function(){return this.ui.focus?this.ui.focus:null},d.prototype.enable=function(){return this._isEnable=!0,this.$el.removeClass(this.options.disabledClass),this.$el},d.prototype.disable=function(){return this._isEnable=!1,this.$el.addClass(this.options.disabledClass),this.$el},d.prototype.cancel=function(){return this._prevent(),this.$el},d.prototype.refresh=function(){var b=this.ui.focus;return b&&!a(b).is(":visible")&&delete this.ui.focus,this._selected=this.getSelected().length,this.$el},a.fn[e]=function(a){return a&&a.charAt?d._command.apply(this,arguments):a&&(a.addClass||a.parentNode)?d._command.call(this,a):this.each(function(b,c){d.getDataObject(c)||new d(c,a)})}}(jQuery,window);