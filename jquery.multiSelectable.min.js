(function(a,b,c){function h(b){this._name=d,this.options=j.apply(this,arguments),this.el=b,this.$el=a(b),this.ui={},this._selected=0,this._changedItems=[],this._prevItemsState=[],this._isEnable=!0,this._keyModes={},this.options.parentSelector="."+this.options.wrapperClass+" "+this.options.filter,this._init()}function i(b,c){return c?a(b).data("plugin_"+d,c):a(b).data("plugin_"+d)}function j(b,c){return c&&a.each(["item","wrapperClass","focusClass","selectedClass","handler"],function(b,d){null!=c[d]&&(c[d]=a.trim(c[d]+""))}),a.extend({},f,c||{})}function k(b){var f,g,e=i(this);if(e===c)throw Error("Element "+this[0]+" has no plugin "+d);if(e[b]&&a.isFunction(e[b])&&(f=e[b]),f&&"_"!==b.charAt(0))return f.apply(e,arguments);if(b&&b.addClass||b.nodeType)return e.select(a(b).filter(e.options.parentSelector));if(g=this.find(b).filter(e.options.parentSelector),g&&g.length>0)return e.select(g);throw Error("Plugin "+d+' has no method "'+b+'"')}var d="multiSelectable",e=b.document,f={filter:"> *",mouseMode:"select",event:"mousedown",multi:!0,focusBlur:!1,selectionBlur:!1,keyboardInput:!1,loop:!1,handler:null,wrapperClass:"j-"+d,focusClass:"j-"+d+"-focused",selectedClass:"j-"+d+"-selected",disabledClass:"j-"+d+"-disabled",create:function(){},beforeSelect:function(){},focusLost:function(){},select:function(){},unSelect:function(){},unSelectAll:function(){},stop:function(){},destroy:function(){}},g={DOWN:40,UP:38,SHIFT:16,END:35,HOME:36,PAGE_DOWN:34,PAGE_UP:33,A:65};h.prototype.option=function(){var b=arguments[1],d=arguments.length;return d>1&&b.charAt?d>2?(this.options[b]=arguments[2],c):this.options[b]:d>1&&a.isPlainObject(b)?(a.extend(this.options,b),c):this.options},h.prototype.destroy=function(){this._destroy(),this.$el.removeData("plugin_"+d),this.$el=null},h.prototype.select=function(b){this._items=b.addClass?b:a(b),this.ui.target=b[0]||b,this._controller(null)},h.prototype.blur=function(){this.ui.target=null,this._controller(null)},h.prototype.getSelected=function(){return this._getSelected()},h.prototype.getSelectedId=function(){return this._getSelected(!0)},h.prototype.enable=function(){this._isEnable=!0,this.$el.removeClass(this.options.disabledClass)},h.prototype.disable=function(){this._isEnable=!1,this.$el.addClass(this.options.disabledClass)},h.prototype.cancel=function(){this._prevent()},h.prototype.refresh=function(){var b=this.ui.focus;b&&!a(b).is(":visible")&&delete this.ui.focus,this._selected=this.getSelected().length},h.prototype._init=function(){this.$el.addClass(this.options.wrapperClass),this._onHandler(),i(this.$el,this),this.options.create.call(this.$el)},h.prototype._destroy=function(){this.options.destroy.call(this.$el),this._offHandler(),this.ui.focus&&(a(this.ui.focus).removeClass(this.options.focusClass),delete this.ui.focus),this._selected>0&&this.getSelected().removeClass(this.options.selectedClass),this.$el.removeClass(this.options.disabledClass),this.$el.removeClass(this.options.wrapperClass)},h.prototype._prevent=function(){this._isPrevented=!0},h.prototype._cancel=function(b){this._isCancellation=!0,a.each(a(this._changedItems),a.proxy(function(c,d){this._prevItemsState[c]?this._select(b,a(d),!0):this._unselect(b,a(d),!0)},this)),delete this._isCancellation,delete this._isPrevented},h.prototype._onHandler=function(){"click"===this.options.event?"click":"mousedown",this._mouseEventHandler=a.proxy(function(a){this._isEnable&&this._mouseHandler(a)},this),this._keyEventHandler=a.proxy(function(a){this.options.keyboardInput&&this._isEnable&&this._keyHandler(a)},this),a(e).on("click."+this._name+" "+"mousedown"+"."+this._name,this._mouseEventHandler),a(e).on("keydown."+this._name+" "+"keyup"+"."+this._name,this._keyEventHandler)},h.prototype._offHandler=function(){var b="click"===this.options.event?"click":"mousedown";a(e).off(b+"."+this._name,this._mouseEventHandler),a(e).off("keydown."+this._name+" "+"keyup"+"."+this._name,this._keyEventHandler)},h.prototype._keyHandler=function(a){if(this.options.keyboardInput){var e,f,h,d=a.which;if("keyup"===a.type)return d===g.SHIFT&&(delete this._shiftModeAction,delete this._keyModes.shift),c;if(d===g.A&&(a.metaKey||a.ctrlKey)&&this.options.multi)a.preventDefault(),e=this._getItems(),f=!0;else switch(d){case g.HOME:h="prev",e=this._getItems("first");break;case g.END:h="next",e=this._getItems("last");break;case g.DOWN:h="next",e=this._findNextSibling("next");break;case g.UP:h="prev",e=this._findNextSibling("prev")}if(e&&e.length>0){if(a.preventDefault(),this.ui.target=e[0],this._items=e,this.ui.focus&&this.options.multi&&a.shiftKey&&!f){var i=this._getIsSelected(this.ui.focus),j=this._getIsSelected(this.ui.target),k=this._getItems(h,e),l=this._getIsSelected(k);if(this._keyModes.shift&&this._keyModes.shift!==d&&(this._keyModes.shift=null,this._shiftModeAction=null),!i&&j&&this._selected>1);else if(this._keyModes.shift&&"select"===this._shiftModeAction&&j){for(;this._getIsSelected(this._items)&&this._items.length>0;)this._items=this._getItems(h,this._items);this._items.length>0&&(this.ui.target=this._items)}else j&&i&&!l?(this._keyModes.shift=null,this._shiftModeAction=null,this._items=this.ui.focus):i&&j?(this._items=this.ui.focus,this._shiftModeAction||(this._shiftModeAction="unselect")):!i&&j?(this._items=this.ui.focus,this._isTargetWasSelected=!1):i||j||(this.ui.target=this.ui.focus,this._items=this.ui.focus);this._shiftModeAction||(this._shiftModeAction="select"),this._keyModes.shift||(this._keyModes.shift=d),d===g.END||d===g.HOME?this._items=this._rangeSelect():this._isMultiSelect=!0}this._controller(a),this._scrollCalcElem(this.el),this._scrollCalcElem(b)}}},h.prototype._findNextSibling=function(a){var b="next"===a?"first":"last",c=this.ui.focus?this._getItems(a,this.ui.focus):this._getItems(b);return 0===c.length&&this.options.loop&&(c=this._getItems(b)),c},h.prototype._scrollCalcElem=function(c){var h,d=c===b?null:a(c).css("position"),e=a(this.ui.focus).outerHeight(),f=a(c).scrollTop(),g=c===b?a(c).outerHeight():c.clientHeight;c!==b&&"fixed"!==d&&"absolute"!==d&&"relative"!==d?(a(c).css("position","relative"),h=a(this.ui.focus).position().top+f,a(c).css("position",d)):h=c===b?a(this.ui.focus).offset().top:a(this.ui.focus).position().top+f,f>h?a(c).scrollTop(h):h+e>f+g&&a(c).scrollTop(h+e-g)},h.prototype._getTarrget=function(b){for(var e,c=b.target,d=this.options.handler;null!==c&&c!==this.el;)a(c).is(this.options.parentSelector)&&(e=c),d&&a(c).is(d)&&(this.ui.handler=c),c=c.parentNode;return d&&c&&this.ui.handler?e:!d&&c?e:null},h.prototype._getSelected=function(b){return b?a.map(this.$el.children("."+this.options.selectedClass),function(b){return a(b).attr("id")}):this.$el.children("."+this.options.selectedClass)},h.prototype._getSelectedId=function(){return this._getSelected(!0)},h.prototype._getItems=function(b,c){switch(b){case"next":return a(c).next(this.options.parentSelector);case"prev":return a(c).prev(this.options.parentSelector);case"first":return this.$el.find(this.options.filter).first();case"last":return this.$el.find(this.options.filter).last();default:return this.$el.find(this.options.filter)}},h.prototype._mouseHandler=function(b){var d=this.options;if("hybrid"===d.event){if("click"===b.type&&!this._mouseDownMode)return;if(this.ui.target=this._getTarrget(b),this.ui.target&&"mousedown"===b.type&&(this._isTargetWasSelected=this._getIsSelected(this.ui.target),this._isTargetWasSelected))return this._mouseDownMode=!0,c;this._mouseDownMode&&delete this._mouseDownMode}else{if(b.type!==d.event)return;this.ui.target=this._getTarrget(b)}d.multi&&this.ui.target&&((b.shiftKey||b.shiftKey&&b.ctrlKey)&&this.ui.focus?this._items=this._rangeSelect():(b.ctrlKey||b.metaKey||"toggle"===d.mouseMode)&&(this._items=this._multiSelect())),this.ui.target&&!this._items&&(this._items=a(this.ui.target)),this._controller(b)},h.prototype._controller=function(a){return this.options.beforeSelect.call(this.$el,a,this.ui),this._isPrevented?(this._cancel(a),this._stop(a),c):(this._prevFocus=this.ui.focus?this.ui.focus:null,this._isWasSelected=this._selected>0,this.ui.target&&this._isTargetWasSelected===c&&(this._isTargetWasSelected=this._getIsSelected(this.ui.target)),this._isRangeSelect&&this._isTargetWasSelected&&this.ui.target===this.ui.focus||(this._isRangeSelect||this._isMultiSelect?this._isTargetWasSelected?this._unselect(a,this._items):this._select(a,this._items):this.ui.target?(this._selected&&(1===this._selected&&this._getIsSelected(this.ui.focus)?this._unselect(a,this.ui.focus,this._isTargetWasSelected):this._unselectAll(a)),this._select(a,this._items,this._isTargetWasSelected)):(this.options.focusBlur&&this._blur(a),this._selected>0&&this.options.selectionBlur&&this._unselectAll(a))),this._setFocus(this.ui.target),this._stop(a),c)},h.prototype._forEachItem=function(b,c){var d=c>0,e=[],f=this;a(b).each(function(b,g){var h=f._getIsSelected(g),i=d?!h:h,j=g===f.ui.target&&f._isTargetWasSelected;(!j||d||f._isMultiSelect||f._isRangeSelect)&&(i&&(f._isCancellation||(e.push(g),f._prevItemsState.push(h)),f._selected+=c),a(g).toggleClass(f.options.selectedClass,d))}),this._isCancellation||(this.ui.items=a(e),this._changedItems=this._changedItems.concat(e))},h.prototype._select=function(a,b,c){this._forEachItem(b,1),c||this.options.select.call(this.$el,a,this.ui),this._isPrevented&&!this._isCancellation&&this._cancel(a)},h.prototype._unselect=function(a,b,c){this._forEachItem(b,-1),c||this.options.unSelect.call(this.$el,a,this.ui),this._isPrevented&&!this._isCancellation&&this._cancel(a)},h.prototype._unselectAll=function(a){if(this._selected&&0!==this._selected){var b=this._getItems();isOnlyTargetSelected=this.ui.target&&this._isTargetWasSelected&&1===this._selected,this.ui.items=null,this._unselect(a,b,isOnlyTargetSelected)}},h.prototype._multiSelect=function(){return this._isMultiSelect=!0,a(this.ui.target)},h.prototype._rangeSelect=function(){if(this._isRangeSelect=!0,this.ui.target===this.ui.focus)return a(this.ui.target);var b=this._getItems(),c=b.index(this.ui.target),d=b.index(this.ui.focus),e=d>c?b.slice(c,d):b.slice(d,c);return e.push(d>c?b[d]:b[c]),e},h.prototype._getIsSelected=function(b){if(1>=a(b).length)return a(b).hasClass(this.options.selectedClass);var c=this.options;return a.map(a(b),function(b){return a(b).hasClass(c.selectedClass)})},h.prototype._blur=function(b,c){!c&&this.ui.focus&&this.options.focusLost.call(this.$el,b,this.ui),this.options.selectionBlur&&this._selected&&this._unselectAll(b),this.ui.focus&&(a(this.ui.focus).removeClass(this.options.focusClass),delete this.ui.focus)},h.prototype._setFocus=function(b){return b?(this.ui.focus&&a(this.ui.focus).removeClass(this.options.focusClass),this.ui.focus=b,a(this.ui.focus).addClass(this.options.focusClass),this.ui.focus):c},h.prototype._stop=function(a){if(!this._selected&&this._isWasSelected)if(this._prevFocus){var b=this.ui.focus;this.ui.focus=this._prevFocus,this.options.unSelectAll.call(this.$el,a,this.ui),this.ui.focus=b}else this.options.unSelectAll.call(this.$el,a,this.ui);this.ui.items=this._changedItems,this.options.stop.call(this.$el,a,this.ui),this._isPrevented&&this._cancel(a),this._changedItems=[],this._prevItemsState=[],delete this.ui.items,delete this.ui.target,delete this.ui.handler,delete this._items,delete this._isRangeSelect,delete this._isMultiSelect,delete this._isTargetWasSelected,delete this._isWasSelected},a.fn[d]=function(a){if(a&&a.charAt){var b=k.apply(this,arguments);return b!==c?b:this}return a&&a.addClass||a.parentNode?k.call(this,a):this.each(function(){i(this)||new h(this,a)})}})(jQuery,window);